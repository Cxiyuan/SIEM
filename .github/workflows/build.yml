name: Build and Push Docker Images

on:
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*'
  pull_request:
    branches:
      - main

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-backend:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: false
          tags: siem-backend:latest
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Save Backend image
        run: |
          mkdir -p images
          docker save siem-backend:latest -o images/siem-backend.tar

      - name: Upload Backend image
        uses: actions/upload-artifact@v4
        with:
          name: backend-image
          path: images/siem-backend.tar
          retention-days: 30

  build-frontend:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: false
          tags: siem-frontend:latest
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Save Frontend image
        run: |
          mkdir -p images
          docker save siem-frontend:latest -o images/siem-frontend.tar

      - name: Upload Frontend image
        uses: actions/upload-artifact@v4
        with:
          name: frontend-image
          path: images/siem-frontend.tar
          retention-days: 30

  create-deployment-package:
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Backend image
        uses: actions/download-artifact@v4
        with:
          name: backend-image
          path: images

      - name: Download Frontend image
        uses: actions/download-artifact@v4
        with:
          name: frontend-image
          path: images

      - name: Pull OpenSearch image
        run: |
          docker pull opensearchproject/opensearch:3.4.0
          docker save opensearchproject/opensearch:3.4.0 -o images/opensearch.tar

      - name: Create deployment scripts
        run: |
          mkdir -p deployment
          cp docker-compose.yml deployment/
          cp scripts/deploy.sh deployment/
          cp scripts/stop.sh deployment/
          cp .env.example deployment/
          chmod +x deployment/deploy.sh deployment/stop.sh

      - name: Create load script
        run: |
          cat > deployment/load-images.sh << 'EOF'
          #!/bin/bash
          echo "Loading Docker images..."
          docker load -i opensearch.tar
          docker load -i siem-backend.tar
          docker load -i siem-frontend.tar
          docker tag siem-backend:latest siem-backend:latest
          docker tag siem-frontend:latest siem-frontend:latest
          echo "Images loaded successfully!"
          EOF
          chmod +x deployment/load-images.sh

      - name: Copy images to deployment
        run: |
          mv images/*.tar deployment/

      - name: Create deployment archive
        run: |
          cd deployment
          tar -czf ../siem-deployment.tar.gz *

      - name: Upload deployment package
        uses: actions/upload-artifact@v4
        with:
          name: siem-deployment-${{ github.sha }}
          path: siem-deployment.tar.gz
          retention-days: 30

      - name: Delete intermediate artifacts
        uses: geekyeggo/delete-artifact@v5
        with:
          name: |
            backend-image
            frontend-image